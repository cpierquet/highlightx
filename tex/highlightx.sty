% Author     : C. Pierquet
% licence    : Released under the LaTeX Project Public License v1.3c or later, see http://www.latex-project.org/lppl.txtf

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{highlightx}[2023/09/01 0.1.1 Macros pour surligner du texte, meme en mode paragraphe]

%====HISTORIQUE
% v 0.1.1	Suppression code paragraphe avec effet
% v 0.1.0	Version initiale [fr] et [en]

%====BASE
\RequirePackage{soul}
\RequirePackage{tikz}
\RequirePackage{xstring}
\RequirePackage{simplekv}
\usetikzlibrary{tikzmark,calc,decorations.pathmorphing}
\colorlet{hlcolback}{yellow!35}

%====COMMANDES POUR FORMULES
\tikzstyle{encadreformule}=[decorate,decoration={random steps,amplitude=0.5pt,segment length=1em}]
\tikzstyle{borderformula}=[decorate,decoration={random steps,amplitude=0.5pt,segment length=1em}]

\defKV[surlignformule]{%
	Fond=\def\surlignformulefond{#1},%
	Bord=\def\surlignformulebord{#1},%
	Texte=\def\surlignformuletexte{#1},%
	Offset=\def\surlignformuleoffset{#1}
}
\setKVdefault[surlignformule]{%
	Fond=hlcolback,%
	Bord=none,%
	Texte=black,%
	Offset=1pt/2pt
}

\NewDocumentCommand\SurlignerFormule{ s O{\surlignformulefond} m D<>{} }{%
	\useKVdefault[surlignformule]%
	\setKV[surlignformule]{#2}%
	\IfSubStr{\surlignformuleoffset}{/}%
		{%
			\StrCut{\surlignformuleoffset}{/}{\surlignformuleoffsetH}{\surlignformuleoffsetV}%
		}%
		{%
			\def\surlignformuleoffsetH{\surlignformuleoffset}\def\surlignformuleoffsetV{\surlignformuleoffset}%
		}%
	\tikzmarknode[inner sep=0pt,outer sep=0pt]{formule}{\ensuremath{#3}}%
	\begin{tikzpicture}[remember picture,overlay]
		\IfBooleanTF{#1}%
			{%
				\fill[\surlignformulefond,draw=\surlignformulebord,#4] ([xshift=-\surlignformuleoffsetH,yshift=-\surlignformuleoffsetV]formule.south west) rectangle ([xshift=\surlignformuleoffsetH,yshift=\surlignformuleoffsetV]formule.north east) node[text=\surlignformuletexte,midway] {\ensuremath{#3}} ;
			}%
			{%
				\fill[\surlignformulefond,draw=\surlignformulebord,encadreformule,#4] ([xshift=-\surlignformuleoffsetH,yshift=-\surlignformuleoffsetV]formule.south west) rectangle ([xshift=\surlignformuleoffsetH,yshift=\surlignformuleoffsetV]formule.north east) node[text=\surlignformuletexte,midway] {\ensuremath{#3}} ;
			}
	\end{tikzpicture}%
}

\defKV[hlformula]{%
	bg=\def\hlformulabg{#1},%
	border=\def\hlformulaborder{#1},%
	text=\def\surlignformulatext{#1},%
	offset=\def\hlformulaoffset{#1}
}
\setKVdefault[hlformula]{%
	bg=hlcolback,%
	border=none,%
	text=black,%
	offset=1pt/2pt
}

\NewDocumentCommand\HighlightFormula{ s O{\surlignformulefond} m D<>{} }{%
	\useKVdefault[hlformula]%
	\setKV[hlformula]{#2}%
	\IfSubStr{\hlformulaoffset}{/}%
		{%
			\StrCut{\hlformulaoffset}{/}{\hlformulaoffsetH}{\hlformulaoffsetV}%
		}%
		{%
			\def\hlformulaoffsetH{\hlformulaoffset}\def\hlformulaoffsetV{\hlformulaoffset}%
		}%
	\tikzmarknode[inner sep=0pt,outer sep=0pt]{formula}{\ensuremath{#3}}%
	\begin{tikzpicture}[remember picture,overlay]
		\IfBooleanTF{#1}%
			{%
				\fill[\hlformulabg,draw=\hlformulaborder,#4] ([xshift=-\hlformulaoffsetH,yshift=-\hlformulaoffsetV]formula.south west) rectangle ([xshift=\hlformulaoffsetH,yshift=\hlformulaoffsetV]formula.north east) node[text=\surlignformulatext,midway] {\ensuremath{#3}} ;
			}%
			{%
				\fill[\hlformulabg,draw=\hlformulaborder,borderformula,#4] ([xshift=-\hlformulaoffsetH,yshift=-\hlformulaoffsetV]formula.south west) rectangle ([xshift=\hlformulaoffsetH,yshift=\hlformulaoffsetV]formula.north east) node[text=\surlignformulatext,midway] {\ensuremath{#3}} ;
			}
	\end{tikzpicture}%
}

%====COMMANDES POUR PARAGRAPHES SIMPLES (sans effet, pour du tcbox par exemple)
\NewDocumentCommand\genhighlightpar{ O{hlcolback} m }{%
	{\sethlcolor{#1}\hl{#2}}%
}

\endinput